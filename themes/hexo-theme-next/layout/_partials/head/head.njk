<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta http-equiv="Permissions-Policy" content="accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), encrypted-media=()">
{%- if theme.darkmode %}
<meta name="theme-color" content="{{ theme.theme_color.light }}" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="{{ theme.theme_color.dark }}" media="(prefers-color-scheme: dark)">
{%- else %}
<meta name="theme-color" content="{{ theme.theme_color.light }}">
{%- endif %}
{%- if config.meta_generator %}
  {{- meta_generator() }}
{%- endif %}

{%- if theme.preconnect %}
  <link rel="preload" href="{{ url_for(theme.css) }}/main.css" as="style">
  <!-- é¢„è¿æ¥åˆ°å¤–éƒ¨èµ„æºä»¥æé«˜åŠ è½½é€Ÿåº¦ -->
  <link rel="preconnect" href="//fonts.loli.net" crossorigin>
  <link rel="preconnect" href="//music.163.com" crossorigin>
  <link rel="preconnect" href="//cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="//busuanzi.ibruce.info" crossorigin>
  <link rel="dns-prefetch" href="//fonts.loli.net">
  <link rel="dns-prefetch" href="//music.163.com">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="//busuanzi.ibruce.info">
{%- endif %}
{{ next_pre() }}

{%- if theme.favicon.apple_touch_icon %}
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for(theme.favicon.apple_touch_icon) }}">
{%- endif %}
{%- if theme.favicon.medium %}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for(theme.favicon.medium) }}">
{%- endif %}
{%- if theme.favicon.small %}
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for(theme.favicon.small) }}">
{%- endif %}
{%- if theme.favicon.safari_pinned_tab %}
  <link rel="mask-icon" href="{{ url_for(theme.favicon.safari_pinned_tab) }}" color="{{ theme.theme_color.light }}">
{%- endif %}
{%- if theme.favicon.android_manifest %}
  <link rel="manifest" href="{{ url_for(theme.favicon.android_manifest) }}">
{%- endif %}

{%- if theme.google_site_verification %}
  <meta name="google-site-verification" content="{{ theme.google_site_verification }}">
{%- endif %}
{%- if theme.bing_site_verification %}
  <meta name="msvalidate.01" content="{{ theme.bing_site_verification }}">
{%- endif %}
{%- if theme.yandex_site_verification %}
  <meta name="yandex-verification" content="{{ theme.yandex_site_verification }}">
{%- endif %}
{%- if theme.baidu_site_verification %}
  <meta name="baidu-site-verification" content="{{ theme.baidu_site_verification }}">
{%- endif %}

<link rel="stylesheet" href="{{ url_for(theme.css) }}/main.css">

{{ next_font() }}

{{ next_vendors('fontawesome') }}

{%- if theme.motion.enable %}
  {{ next_vendors('animate_css') }}
{%- endif %}

{%- if theme.fancybox %}
  {{ next_vendors('fancybox_css') }}
{%- endif %}

{%- if theme.pace.enable %}
  {{ next_vendors('pace_css') }}
  {{ next_vendors('pace_js') }}
{%- endif %}

{{ next_data('main', next_config()) }}
{{- next_js('config.js') }}
{{- next_js('theme-badge-toggle.js') }}

<!-- è‡ªå®šä¹‰ Live Reload for Development -->
<script>
(function() {
  'use strict';
  
  // ä»…åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å¯ç”¨
  if (typeof window !== 'undefined' && 
      (window.location.hostname === 'localhost' || 
       window.location.hostname === '127.0.0.1')) {
    
    console.log('ğŸ”„ Initializing Smart Live Reload for development...');
    
    let lastPageHash = null;
    let checkCount = 0;
    let isChecking = false;
    let stableCount = 0;
    let initialized = false;
    let currentUrl = window.location.href;
    let checkInterval = null;
    let urlChangeDetected = false;
    
    // ç”Ÿæˆé¡µé¢å†…å®¹å“ˆå¸Œï¼ˆæ’é™¤åŠ¨æ€å…ƒç´ ï¼‰
    function generatePageHash(htmlContent) {
      try {
        // ç§»é™¤å¯èƒ½å˜åŒ–çš„åŠ¨æ€å†…å®¹
        let cleanHtml = htmlContent;
        
        // ç§»é™¤æ—¶é—´æˆ³ã€è®¿é—®ç»Ÿè®¡ç­‰åŠ¨æ€å†…å®¹çš„æ­£åˆ™
        const dynamicPatterns = [
          /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/g,  // ISOæ—¶é—´æˆ³
          /\d{4}\/\d{2}\/\d{2}/g,                   // æ—¥æœŸæ ¼å¼
          /\d{2}:\d{2}:\d{2}/g,                     // æ—¶é—´æ ¼å¼
          /<script[^>]*>[\s\S]*?<\/script>/gi,      // æ‰€æœ‰scriptæ ‡ç­¾
          /busuanzi_value_\w+/g,                    // ä¸è’œå­ç»Ÿè®¡
          /leancloud_visitors/g,                    // LeanCloudè®¿é—®ç»Ÿè®¡
          /live2d-widget/g,                         // Live2D
          /persistent-music-player/g,               // éŸ³ä¹æ’­æ”¾å™¨
          /hexo-neat/g                              // hexo-neat å‹ç¼©æ ‡è®°
        ];
        
        dynamicPatterns.forEach(function(pattern) {
          cleanHtml = cleanHtml.replace(pattern, '');
        });
        
        // ç®€å•å“ˆå¸Œå‡½æ•°
        let hash = 0;
        for (let i = 0; i < cleanHtml.length; i++) {
          const char = cleanHtml.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        
        return hash.toString();
      } catch (error) {
        console.log('âš ï¸ Error generating page hash:', error);
        return Math.random().toString();
      }
    }
    
    // æ£€æµ‹URLå˜åŒ–
    function checkUrlChange() {
      const newUrl = window.location.href;
      if (newUrl !== currentUrl) {
        console.log('ğŸ”— URL changed detected!');
        console.log('ğŸ“ From:', currentUrl);
        console.log('ğŸ“ To:', newUrl);
        
        // é‡ç½®çŠ¶æ€ä»¥é€‚åº”æ–°é¡µé¢
        currentUrl = newUrl;
        lastPageHash = null;
        initialized = false;
        stableCount = 0;
        urlChangeDetected = true;
        
        // URLå˜åŒ–åå»¶è¿Ÿé‡æ–°åˆå§‹åŒ–ï¼Œé¿å…è¯¯è§¦å‘åˆ·æ–°
        setTimeout(function() {
          urlChangeDetected = false;
          console.log('ğŸ”„ Reinitializing Live Reload for new page...');
          checkForUpdates();
        }, 2000);
        
        return true;
      }
      return false;
    }
    
    function checkForUpdates() {
      // æ£€æŸ¥URLæ˜¯å¦å˜åŒ–
      if (checkUrlChange()) {
        return;
      }
      
      // å¦‚æœåˆšåˆšæ£€æµ‹åˆ°URLå˜åŒ–ï¼Œè·³è¿‡è¿™æ¬¡æ£€æŸ¥
      if (urlChangeDetected) {
        console.log('â­ï¸ Skipping check due to recent URL change...');
        return;
      }
      
      if (isChecking) {
        return;
      }
      
      isChecking = true;
      checkCount++;
      
      fetch(window.location.href + '?_=' + Date.now(), {
        method: 'GET',
        cache: 'no-cache',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      }).then(function(response) {
        return response.text();
      }).then(function(html) {
        const currentHash = generatePageHash(html);
        
        if (!initialized) {
          lastPageHash = currentHash;
          initialized = true;
          console.log('ğŸ Page hash initialized:', currentHash.substring(0, 8) + '...', 'for', currentUrl);
          stableCount = 0;
        } else if (currentHash !== lastPageHash) {
          console.log('âœ¨ Page content changed!');
          console.log('ğŸ“Š Hash changed from', lastPageHash.substring(0, 8) + '...', 'to', currentHash.substring(0, 8) + '...');
          console.log('ğŸ”„ Reloading page in 300ms...');
          
          // æ¸…ç†å®šæ—¶å™¨
          if (checkInterval) {
            clearTimeout(checkInterval);
          }
          
          // é‡ç½®çŠ¶æ€ï¼Œå‡†å¤‡é‡æ–°åŠ è½½
          initialized = false;
          lastPageHash = null;
          isChecking = false;
          
          // å‡å°‘é‡æ–°åŠ è½½å»¶è¿Ÿï¼Œæå‡å“åº”é€Ÿåº¦
          setTimeout(function() {
            window.location.reload();
          }, 300);
          return;
        } else {
          stableCount++;
          
          // åŠ¨æ€è°ƒæ•´æ£€æµ‹é—´éš”ï¼šæ²¡æœ‰å˜åŒ–æ—¶é€æ¸å»¶é•¿é—´éš”
          if (stableCount < 3) {
            currentInterval = minInterval; // å‰3æ¬¡æ£€æµ‹ä¿æŒæœ€å¿«é€Ÿåº¦
          } else if (stableCount < 10) {
            currentInterval = 2000; // 4-10æ¬¡æ£€æµ‹æ¯2ç§’ä¸€æ¬¡
          } else if (stableCount < 20) {
            currentInterval = 3000; // 11-20æ¬¡æ£€æµ‹æ¯3ç§’ä¸€æ¬¡
          } else {
            currentInterval = maxInterval; // 20æ¬¡åæ¯5ç§’ä¸€æ¬¡
          }
          
          if (stableCount <= 2 || stableCount % 8 === 0) {
            console.log('ğŸ“‹ Check #' + checkCount + ' - No changes detected (stable: ' + stableCount + ', interval: ' + currentInterval + 'ms)');
          }
        }
        
        isChecking = false;
      }).catch(function(error) {
        console.log('âŒ Check #' + checkCount + ' failed:', error.message);
        isChecking = false;
      });
    }
    
    // Pjax/é¡µé¢è·³è½¬ç›‘å¬
    function setupNavigationListeners() {
      // ç›‘å¬ Pjax äº‹ä»¶
      document.addEventListener('pjax:success', function() {
        console.log('ğŸš€ Pjax navigation detected');
        urlChangeDetected = true;
        setTimeout(function() {
          checkUrlChange();
        }, 500);
      });
      
      // ç›‘å¬ History API å˜åŒ–
      const originalPushState = history.pushState;
      const originalReplaceState = history.replaceState;
      
      history.pushState = function() {
        originalPushState.apply(history, arguments);
        setTimeout(checkUrlChange, 100);
      };
      
      history.replaceState = function() {
        originalReplaceState.apply(history, arguments);
        setTimeout(checkUrlChange, 100);
      };
      
      // ç›‘å¬ popstate äº‹ä»¶ï¼ˆæµè§ˆå™¨å‰è¿›/åé€€ï¼‰
      window.addEventListener('popstate', function() {
        console.log('â¬…ï¸ Browser navigation detected');
        setTimeout(checkUrlChange, 100);
      });
    }
    
    // å®šä¹‰å…¨å±€å˜é‡
    const maxInterval = 5000; // æœ€å¤§é—´éš”5ç§’
    const minInterval = 1000; // æœ€å°é—´éš”1ç§’
    let currentInterval = 2000; // åˆå§‹2ç§’æ£€æµ‹ä¸€æ¬¡
    
    // åˆå§‹åŒ–
    function initialize() {
      setupNavigationListeners();
      
      // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åå¼€å§‹æ£€æŸ¥
      setTimeout(function() {
        checkForUpdates();
        
        function scheduleNextCheck() {
          clearTimeout(checkInterval);
          checkInterval = setTimeout(() => {
            checkForUpdates();
            scheduleNextCheck();
          }, currentInterval);
        }
        
        scheduleNextCheck();
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
          if (checkInterval) {
            clearTimeout(checkInterval);
          }
        });
      }, 3000);
      
      // ç›‘å¬é¡µé¢ç„¦ç‚¹ï¼Œç”¨æˆ·å›åˆ°é¡µé¢æ—¶ç«‹å³æ£€æŸ¥
      window.addEventListener('focus', function() {
        if (initialized && !urlChangeDetected) {
          console.log('ğŸ‘ï¸ Page focused - checking for updates...');
          // é‡ç½®æ£€æµ‹é—´éš”ä¸ºæœ€å¿«é€Ÿåº¦
          currentInterval = minInterval;
          setTimeout(checkForUpdates, 300);
        }
      });
      
      // æ·»åŠ é”®ç›˜å¿«æ·é”® Ctrl+R / Cmd+R å¿«é€Ÿåˆ·æ–°æ£€æµ‹
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'r' && !e.shiftKey) {
          if (initialized && !urlChangeDetected) {
            console.log('âš¡ Manual refresh detected - quick check...');
            // é˜»æ­¢é»˜è®¤åˆ·æ–°ï¼Œå…ˆæ£€æŸ¥æ›´æ–°
            e.preventDefault();
            currentInterval = minInterval;
            setTimeout(() => {
              checkForUpdates();
              // å¦‚æœ500mså†…æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ–°ï¼Œåˆ™æ­£å¸¸åˆ·æ–°
              setTimeout(() => {
                if (!isChecking) {
                  window.location.reload();
                }
              }, 500);
            }, 100);
          }
        }
      });
      
      // æ·»åŠ å¯è§æ€§å˜åŒ–ç›‘å¬ï¼Œé¡µé¢å˜ä¸ºå¯è§æ—¶å¿«é€Ÿæ£€æµ‹
      if (typeof document.visibilityState !== 'undefined') {
        document.addEventListener('visibilitychange', function() {
          if (!document.hidden && initialized && !urlChangeDetected) {
            console.log('ğŸ‘€ Page became visible - quick check...');
            currentInterval = minInterval;
            setTimeout(checkForUpdates, 200);
          }
        });
      }
    }
    
    // å¯åŠ¨åˆå§‹åŒ–
    initialize();
    
    console.log('âœ… Enhanced Live Reload initialized');
    console.log('ğŸ’¡ Smart interval: 1s â†’ 2s â†’ 3s â†’ 5s based on stability');
    console.log('ğŸ¯ Only real content changes will trigger reload');
    console.log('ğŸ”— URL changes will be handled gracefully');
    console.log('âš¡ Press Ctrl+R/Cmd+R for instant check');
    console.log('ğŸ‘€ Auto-detects when page becomes visible');
  }
})();
</script>

<script>
/* Service Worker æ³¨å†Œ - æå‡ç¼“å­˜æ€§èƒ½ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

/* æŒä¹…åŒ–éŸ³ä¹æ’­æ”¾å™¨ - é¿å…Pjaxé‡ç½® */
(function() {
    'use strict';
    
    let musicPlayer = null;
    const MUSIC_PLAYER_ID = 'persistent-music-player';
    
    // åˆ›å»ºéŸ³ä¹æ’­æ”¾å™¨HTML
    function createMusicPlayer() {
        const playerHtml = `
            <div id="${MUSIC_PLAYER_ID}" class="persistent-music-player minimized">
                <div class="music-controls">
                    <button class="music-toggle-btn" onclick="toggleMusicPlayer()" title="ç‚¹å‡»åˆ‡æ¢æ’­æ”¾å™¨æ˜¾ç¤º/éšè—&#10;æ¡Œé¢ç«¯å³é”®å¼€å¯/å…³é—­æ—‹è½¬&#10;æ‰‹æœºç«¯é•¿æŒ‰1ç§’å¼€å¯/å…³é—­æ—‹è½¬">â™ª</button>
                    <button class="music-minimize-btn" onclick="minimizeMusicPlayer()" title="æœ€å°åŒ–">âˆ’</button>
                </div>
                <div class="music-iframe-container">
                    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" 
                            width="330" height="450" loading="lazy"
                            sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-top-navigation"
                            referrerpolicy="no-referrer-when-downgrade"
                            allow="autoplay; encrypted-media; fullscreen"
                            src="https://music.163.com/outchain/player?type=0&id=6922474495&auto=0&height=430">
                    </iframe>
                    <div class="music-fallback" style="display: none;">
                        <p>éŸ³ä¹æ’­æ”¾å™¨åŠ è½½å¤±è´¥ï¼Ÿ</p>
                        <a href="https://music.163.com/playlist?id=6922474495" target="_blank" rel="noopener">
                            ç‚¹å‡»å‰å¾€ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾
                        </a>
                    </div>
                </div>
            </div>
        `;
        return playerHtml;
    }
    
    // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
    function initMusicPlayer() {
        // å¦‚æœå·²å­˜åœ¨ï¼Œä¸é‡å¤åˆ›å»º
        if (document.getElementById(MUSIC_PLAYER_ID)) {
            return;
        }
        
        // åˆ›å»ºæ’­æ”¾å™¨å®¹å™¨
        const playerContainer = document.createElement('div');
        playerContainer.innerHTML = createMusicPlayer();
        
        // æ·»åŠ åˆ°bodyæœ«å°¾ï¼Œç¡®ä¿ä¸è¢«Pjaxå½±å“
        document.body.appendChild(playerContainer.firstElementChild);
        
        // ç¡®ä¿æ’­æ”¾å™¨ä¸ä¼šè¢«Pjaxæ›¿æ¢
        const player = document.getElementById(MUSIC_PLAYER_ID);
        if (player) {
            player.setAttribute('data-pjax-ignore', 'true');
            // æ’­æ”¾å™¨é»˜è®¤ä¸ºæœ€å°åŒ–çŠ¶æ€
            player.classList.add('minimized');
            
            // æ£€æµ‹iframeæ˜¯å¦åŠ è½½æˆåŠŸ
            setTimeout(() => {
                checkIframeLoad();
            }, 3000);
        }
    }
    
    // æ£€æµ‹iframeåŠ è½½çŠ¶æ€
    function checkIframeLoad() {
        const iframe = document.querySelector('.music-iframe-container iframe');
        const fallback = document.querySelector('.music-fallback');
        
        if (!iframe || !fallback) return;
        
        let loadTimeout;
        let hasLoaded = false;
        
        // ç›‘å¬iframeåŠ è½½æˆåŠŸäº‹ä»¶
        iframe.addEventListener('load', function() {
            hasLoaded = true;
            clearTimeout(loadTimeout);
            console.log('Music player iframe loaded successfully');
        });
        
        // ç›‘å¬iframeåŠ è½½é”™è¯¯äº‹ä»¶
        iframe.addEventListener('error', function() {
            console.warn('Music player iframe failed to load');
            showFallback();
        });
        
        // è®¾ç½®è¶…æ—¶æ£€æµ‹ - å¦‚æœè¶…æ—¶è¿˜æ²¡åŠ è½½æˆåŠŸï¼Œæ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
        loadTimeout = setTimeout(() => {
            if (!hasLoaded) {
                console.warn('Music player iframe loading timeout');
                showFallback();
            }
        }, 8000); // å¢åŠ è¶…æ—¶æ—¶é—´åˆ°8ç§’ï¼Œç»™iframeæ›´å¤šåŠ è½½æ—¶é—´
        
        function showFallback() {
            clearTimeout(loadTimeout);
            if (fallback) {
                iframe.style.display = 'none';
                fallback.style.display = 'block';
            }
        }
    }
    
    // éŸ³ä¹å›¾æ ‡æ—‹è½¬æ§åˆ¶
    let musicIconRotating = false;
    let longPressTimer = null;
    let rotationToggleTimeout = null;
    
    // åˆ‡æ¢éŸ³ä¹å›¾æ ‡æ—‹è½¬çŠ¶æ€
    function toggleMusicRotation() {
        // é˜²æŠ–ï¼šé¿å…å¿«é€Ÿé‡å¤è°ƒç”¨
        if (rotationToggleTimeout) {
            console.log('ğŸµ Toggle rotation debounced - ignoring repeated call');
            return;
        }
        
        const toggleBtn = document.querySelector('.music-toggle-btn');
        if (!toggleBtn) {
            console.warn('ğŸµ Toggle button not found');
            return;
        }
        
        musicIconRotating = !musicIconRotating;
        console.log('ğŸµ Toggling rotation state to:', musicIconRotating);
        
        if (musicIconRotating) {
            toggleBtn.classList.add('rotating');
            localStorage.setItem('musicIconRotating', 'true');
            console.log('ğŸµ Rotation enabled');
        } else {
            toggleBtn.classList.remove('rotating');
            localStorage.setItem('musicIconRotating', 'false');
            console.log('ğŸµ Rotation disabled');
        }
        
        // è®¾ç½®é˜²æŠ–å»¶è¿Ÿï¼Œ500mså†…ä¸å…è®¸å†æ¬¡è°ƒç”¨
        rotationToggleTimeout = setTimeout(function() {
            rotationToggleTimeout = null;
        }, 500);
    }
    
    // æ¢å¤éŸ³ä¹å›¾æ ‡æ—‹è½¬çŠ¶æ€
    function restoreMusicRotationState() {
        const toggleBtn = document.querySelector('.music-toggle-btn');
        if (!toggleBtn) return;
        
        const savedState = localStorage.getItem('musicIconRotating');
        if (savedState === 'true') {
            musicIconRotating = true;
            toggleBtn.classList.add('rotating');
        }
    }
    
    // æ·»åŠ éŸ³ä¹å›¾æ ‡äº¤äº’äº‹ä»¶
    function addMusicIconEvents() {
        const toggleBtn = document.querySelector('.music-toggle-btn');
        if (!toggleBtn) return;
        
        // é˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶
        if (toggleBtn.hasAttribute('data-events-bound')) {
            console.log('ğŸµ Events already bound, skipping...');
            return;
        }
        toggleBtn.setAttribute('data-events-bound', 'true');
        console.log('ğŸµ Binding events to music toggle button');
        
        // æ¡Œé¢ç«¯å³é”®äº‹ä»¶ï¼ˆä»…åœ¨éè§¦æ‘¸è®¾å¤‡ä¸Šå¯ç”¨ï¼‰
        if (!('ontouchstart' in window) && !navigator.maxTouchPoints) {
            toggleBtn.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                console.log('ğŸµ Right click detected - toggling rotation');
                toggleMusicRotation();
            });
        } else {
            console.log('ğŸµ Touch device detected - disabling right click rotation');
        }
        
        // ç§»åŠ¨ç«¯é•¿æŒ‰äº‹ä»¶
        let touchStartTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        let isLongPressing = false;
        
        toggleBtn.addEventListener('touchstart', function(e) {
            touchStartTime = Date.now();
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isLongPressing = false;
            
            console.log('ğŸµ Touch start - starting long press timer (1s)');
            
            longPressTimer = setTimeout(function() {
                console.log('ğŸµ Long press triggered - toggling rotation');
                isLongPressing = true;
                // æ ‡è®°ä¸ºé•¿æŒ‰ï¼Œé¿å…è§¦å‘ç‚¹å‡»
                toggleBtn.setAttribute('data-long-pressed', 'true');
                toggleMusicRotation();
                // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }, 1000); // æ”¹ä¸º1ç§’
        });
        
        toggleBtn.addEventListener('touchend', function(e) {
            const touchDuration = Date.now() - touchStartTime;
            console.log('ğŸµ Touch end - duration:', touchDuration + 'ms', 'isLongPressing:', isLongPressing);
            
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            // å¦‚æœæ˜¯é•¿æŒ‰ï¼Œé˜»æ­¢åç»­çš„ç‚¹å‡»äº‹ä»¶
            if (e.target.getAttribute('data-long-pressed') === 'true') {
                e.preventDefault();
                e.stopPropagation();
                e.target.removeAttribute('data-long-pressed');
            }
        });
        
        toggleBtn.addEventListener('touchmove', function(e) {
            // è®¡ç®—ç§»åŠ¨è·ç¦»ï¼Œåªæœ‰ç§»åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼æ‰å–æ¶ˆé•¿æŒ‰
            const moveX = Math.abs(e.touches[0].clientX - touchStartX);
            const moveY = Math.abs(e.touches[0].clientY - touchStartY);
            const moveDistance = Math.sqrt(moveX * moveX + moveY * moveY);
            
            // å…è®¸10åƒç´ çš„ç§»åŠ¨è¯¯å·®ï¼Œé¿å…è½»å¾®æ‰‹æŠ–å°±å–æ¶ˆé•¿æŒ‰
            if (moveDistance > 10) {
                console.log('ğŸµ Touch move too far - canceling long press. Distance:', moveDistance);
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }
        });
        
        // æ·»åŠ é¢å¤–çš„é˜²é€‰ä¸­äº‹ä»¶
        toggleBtn.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        toggleBtn.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // é¡µé¢ä¸å¯è§æ—¶æ¸…ç†é•¿æŒ‰è®¡æ—¶å™¨
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && longPressTimer) {
                console.log('ğŸµ Page hidden - clearing long press timer');
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        // é¡µé¢å¤±å»ç„¦ç‚¹æ—¶æ¸…ç†é•¿æŒ‰è®¡æ—¶å™¨
        window.addEventListener('blur', function() {
            if (longPressTimer) {
                console.log('ğŸµ Window blur - clearing long press timer');
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        // æ¢å¤æ—‹è½¬çŠ¶æ€
        restoreMusicRotationState();
        
        // ä¸ºæœ€å°åŒ–æŒ‰é’®æ·»åŠ ç§»åŠ¨ç«¯ä¼˜åŒ–
        const minimizeBtn = document.querySelector('.music-minimize-btn');
        if (minimizeBtn) {
            // é˜²æ­¢æœ€å°åŒ–æŒ‰é’®çš„æ–‡æœ¬é€‰æ‹©
            minimizeBtn.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            });
            
            minimizeBtn.addEventListener('dragstart', function(e) {
                e.preventDefault();
                return false;
            });
        }
    }
    
    // åˆ‡æ¢æ’­æ”¾å™¨æ˜¾ç¤º/éšè—
    window.toggleMusicPlayer = function() {
        const player = document.getElementById(MUSIC_PLAYER_ID);
        if (!player) return;
        
        if (player.classList.contains('minimized')) {
            player.classList.remove('minimized');
            localStorage.setItem('musicPlayerMinimized', 'false');
        } else {
            player.classList.add('minimized');
            localStorage.setItem('musicPlayerMinimized', 'true');
        }
    };
    

    
    // æœ€å°åŒ–æ’­æ”¾å™¨
    window.minimizeMusicPlayer = function() {
        const player = document.getElementById(MUSIC_PLAYER_ID);
        if (!player) return;
        
        player.classList.add('minimized');
        localStorage.setItem('musicPlayerMinimized', 'true');
    };
    

    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initMusicPlayer();
            setTimeout(addMusicIconEvents, 100);
        });
    } else {
        initMusicPlayer();
        setTimeout(addMusicIconEvents, 100);
    }
    
    // Pjaxé¡µé¢åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–ï¼ˆå¦‚æœæ’­æ”¾å™¨è¢«æ„å¤–ç§»é™¤ï¼‰
    document.addEventListener('pjax:complete', function() {
        setTimeout(function() {
            const existingPlayer = document.getElementById(MUSIC_PLAYER_ID);
            if (!existingPlayer) {
                initMusicPlayer();
                setTimeout(addMusicIconEvents, 100);
            } else {
                // å¦‚æœæ’­æ”¾å™¨å­˜åœ¨ä½†äº‹ä»¶å¯èƒ½ä¸¢å¤±ï¼Œé‡æ–°ç»‘å®š
                const toggleBtn = existingPlayer.querySelector('.music-toggle-btn');
                if (toggleBtn && !toggleBtn.hasAttribute('data-events-bound')) {
                    console.log('ğŸµ Re-binding events after Pjax navigation');
                    setTimeout(addMusicIconEvents, 100);
                }
            }
        }, 100);
    });
    
})();


</script>

<script>
/* Taboola å¹¿å‘Šè¿‡æ»¤è„šæœ¬ - èµ„æºé˜»æ­¢ç‰ˆ */
(function() {
  'use strict';
  
  console.log('ğŸš« å¯åŠ¨ Taboola å¹¿å‘Šè¿‡æ»¤å™¨ï¼ˆèµ„æºé˜»æ­¢ç‰ˆï¼‰...');
  
  // é˜»æ­¢ Taboola ç›¸å…³çš„èµ„æºåŠ è½½
  function blockTaboolaResources() {
    // é˜»æ­¢ XMLHttpRequest è¯·æ±‚
    const originalXHR = window.XMLHttpRequest;
    window.XMLHttpRequest = function() {
      const xhr = new originalXHR();
      const originalOpen = xhr.open;
      
      xhr.open = function(method, url, ...args) {
        if (url && (url.includes('taboola.com') || url.includes('trc.taboola.com'))) {
          console.log('ğŸš« é˜»æ­¢ Taboola è¯·æ±‚:', url);
          return;
        }
        return originalOpen.apply(this, [method, url, ...args]);
      };
      
      return xhr;
    };
    
    // é˜»æ­¢ fetch è¯·æ±‚
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      if (url && (url.includes('taboola.com') || url.includes('trc.taboola.com'))) {
        console.log('ğŸš« é˜»æ­¢ Taboola fetch è¯·æ±‚:', url);
        return Promise.reject(new Error('Blocked Taboola request'));
      }
      return originalFetch.apply(this, arguments);
    };
    
    // é˜»æ­¢åŠ¨æ€è„šæœ¬åŠ è½½
    const originalCreateElement = document.createElement;
    document.createElement = function(tagName) {
      const element = originalCreateElement.call(this, tagName);
      
      if (tagName.toLowerCase() === 'script') {
        const originalSrcSetter = Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype, 'src').set;
        Object.defineProperty(element, 'src', {
          set: function(value) {
            if (value && (value.includes('taboola.com') || value.includes('trc.taboola.com'))) {
              console.log('ğŸš« é˜»æ­¢ Taboola è„šæœ¬åŠ è½½:', value);
              return;
            }
            return originalSrcSetter.call(this, value);
          },
          get: function() {
            return this.getAttribute('src');
          }
        });
      }
      
      return element;
    };
  }
  
  // ç®€å•çš„å¹¿å‘Šç§»é™¤å‡½æ•°
  function removeAds() {
    let removedCount = 0;
    
    // åªå¤„ç†æœ€æ˜æ˜¾çš„å¹¿å‘Šå…ƒç´ 
    const selectors = [
      '#taboola-livere',
      'div[class*="trc_related_container"]',
      'div[class*="tbl-trecs-container"]',
      'div[class*="trc_spotlight_widget"]',
      'div[data-placement-name*="1020_29982"]',
      'div[class*="trc_rbox_container"]',
      'div[class*="trc_rbox"]',
      'div[class*="thumbnails-b"]',
      'div[class*="trc-content-sponsored"]',
      'figure[id*="taboola"]',
      'div[class*="videoCube"]',
      'div[class*="trc_spotlight_item"]',
      'div[data-item-syndicated="true"]',
      'a[href*="popup.taboola.com"]',
      'a[href*="trc.taboola.com"]'
    ];
    
    selectors.forEach(function(selector) {
      try {
        const elements = document.querySelectorAll(selector);
        elements.forEach(function(element) {
          if (element && element.parentNode) {
            element.parentNode.removeChild(element);
            removedCount++;
          }
        });
      } catch (error) {
        // å¿½ç•¥é”™è¯¯
      }
    });
    
    if (removedCount > 0) {
      console.log('ğŸ—‘ï¸  æˆåŠŸç§»é™¤', removedCount, 'ä¸ªå¹¿å‘Šå…ƒç´ ');
    }
    
    return removedCount;
  }
  
  // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
  function initAdFilter() {
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    removeAds();
    
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿åŠ¨æ€å†…å®¹åŠ è½½å®Œæˆ
    setTimeout(removeAds, 2000);
    setTimeout(removeAds, 5000);
    
    // å®šæœŸæ£€æŸ¥ï¼ˆå‡å°‘é¢‘ç‡ï¼‰
    setInterval(removeAds, 10000);
  }
  
  // ç«‹å³é˜»æ­¢èµ„æºåŠ è½½
  blockTaboolaResources();
  
  // åˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAdFilter);
  } else {
    initAdFilter();
  }
  
  // Pjax é¡µé¢åˆ‡æ¢åæ‰§è¡Œ
  document.addEventListener('pjax:success', function() {
    setTimeout(removeAds, 1000);
  });
  
  console.log('âœ… Taboola å¹¿å‘Šè¿‡æ»¤å™¨åˆå§‹åŒ–å®Œæˆï¼ˆèµ„æºé˜»æ­¢ç‰ˆï¼‰');
})();
</script>
