<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta http-equiv="Permissions-Policy" content="accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), encrypted-media=()">
{%- if theme.darkmode %}
<meta name="theme-color" content="{{ theme.theme_color.light }}" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="{{ theme.theme_color.dark }}" media="(prefers-color-scheme: dark)">
{%- else %}
<meta name="theme-color" content="{{ theme.theme_color.light }}">
{%- endif %}
{%- if config.meta_generator %}
  {{- meta_generator() }}
{%- endif %}

{%- if theme.preconnect %}
  <link rel="preload" href="{{ url_for(theme.css) }}/main.css" as="style">
  <!-- é¢„è¿æ¥åˆ°å¤–éƒ¨èµ„æºä»¥æé«˜åŠ è½½é€Ÿåº¦ -->
  <link rel="preconnect" href="//fonts.loli.net" crossorigin>
  <link rel="preconnect" href="//music.163.com" crossorigin>
  <link rel="preconnect" href="//cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="//busuanzi.ibruce.info" crossorigin>
  <link rel="dns-prefetch" href="//fonts.loli.net">
  <link rel="dns-prefetch" href="//music.163.com">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="//busuanzi.ibruce.info">
{%- endif %}
{{ next_pre() }}

{%- if theme.favicon.apple_touch_icon %}
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for(theme.favicon.apple_touch_icon) }}">
{%- endif %}
{%- if theme.favicon.medium %}
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for(theme.favicon.medium) }}">
{%- endif %}
{%- if theme.favicon.small %}
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for(theme.favicon.small) }}">
{%- endif %}
{%- if theme.favicon.safari_pinned_tab %}
  <link rel="mask-icon" href="{{ url_for(theme.favicon.safari_pinned_tab) }}" color="{{ theme.theme_color.light }}">
{%- endif %}
{%- if theme.favicon.android_manifest %}
  <link rel="manifest" href="{{ url_for(theme.favicon.android_manifest) }}">
{%- endif %}

{%- if theme.google_site_verification %}
  <meta name="google-site-verification" content="{{ theme.google_site_verification }}">
{%- endif %}
{%- if theme.bing_site_verification %}
  <meta name="msvalidate.01" content="{{ theme.bing_site_verification }}">
{%- endif %}
{%- if theme.yandex_site_verification %}
  <meta name="yandex-verification" content="{{ theme.yandex_site_verification }}">
{%- endif %}
{%- if theme.baidu_site_verification %}
  <meta name="baidu-site-verification" content="{{ theme.baidu_site_verification }}">
{%- endif %}

<link rel="stylesheet" href="{{ url_for(theme.css) }}/main.css">

{{ next_font() }}

{{ next_vendors('fontawesome') }}

{%- if theme.motion.enable %}
  {{ next_vendors('animate_css') }}
{%- endif %}

{%- if theme.fancybox %}
  {{ next_vendors('fancybox_css') }}
{%- endif %}

{%- if theme.pace.enable %}
  {{ next_vendors('pace_css') }}
  {{ next_vendors('pace_js') }}
{%- endif %}

{{ next_data('main', next_config()) }}
{{- next_js('config.js') }}

<!-- è‡ªå®šä¹‰ Live Reload for Development -->
<script>
(function() {
  'use strict';
  
  // ä»…åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å¯ç”¨ï¼Œå¹¶ä¸”éœ€è¦æ˜¾å¼å¯ç”¨
  if (typeof window !== 'undefined' && 
      (window.location.hostname === 'localhost' || 
       window.location.hostname === '127.0.0.1') &&
      window.location.search.includes('livereload=true')) {
    
    console.log('ğŸ”„ Initializing Custom Live Reload for development...');
    
    let lastPageHash = null;
    let checkCount = 0;
    let isChecking = false;
    let stableCount = 0;
    let initialized = false;
    
    // ç”Ÿæˆé¡µé¢å†…å®¹å“ˆå¸Œï¼ˆæ’é™¤åŠ¨æ€å…ƒç´ ï¼‰
    function generatePageHash(htmlContent) {
      try {
        // ç§»é™¤å¯èƒ½å˜åŒ–çš„åŠ¨æ€å†…å®¹
        let cleanHtml = htmlContent;
        
        // ç§»é™¤æ—¶é—´æˆ³ã€è®¿é—®ç»Ÿè®¡ç­‰åŠ¨æ€å†…å®¹çš„æ­£åˆ™
        const dynamicPatterns = [
          /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/g,  // ISOæ—¶é—´æˆ³
          /\d{4}\/\d{2}\/\d{2}/g,                   // æ—¥æœŸæ ¼å¼
          /\d{2}:\d{2}:\d{2}/g,                     // æ—¶é—´æ ¼å¼
          /<script[^>]*>[\s\S]*?<\/script>/gi,      // æ‰€æœ‰scriptæ ‡ç­¾
          /busuanzi_value_\w+/g,                    // ä¸è’œå­ç»Ÿè®¡
          /leancloud_visitors/g,                    // LeanCloudè®¿é—®ç»Ÿè®¡
          /live2d-widget/g,                         // Live2D
          /persistent-music-player/g,               // éŸ³ä¹æ’­æ”¾å™¨
          /hexo-neat/g                              // hexo-neat å‹ç¼©æ ‡è®°
        ];
        
        dynamicPatterns.forEach(function(pattern) {
          cleanHtml = cleanHtml.replace(pattern, '');
        });
        
        // ç®€å•å“ˆå¸Œå‡½æ•°
        let hash = 0;
        for (let i = 0; i < cleanHtml.length; i++) {
          const char = cleanHtml.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        
        return hash.toString();
      } catch (error) {
        console.log('âš ï¸ Error generating page hash:', error);
        return Math.random().toString();
      }
    }
    
    function checkForUpdates() {
      if (isChecking) {
        return;
      }
      
      isChecking = true;
      checkCount++;
      
      fetch(window.location.href + '?_=' + Date.now(), {
        method: 'GET',
        cache: 'no-cache',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      }).then(function(response) {
        return response.text();
      }).then(function(html) {
        const currentHash = generatePageHash(html);
        
        if (!initialized) {
          lastPageHash = currentHash;
          initialized = true;
          console.log('ğŸ Initial page hash set:', currentHash.substring(0, 8) + '...');
          stableCount = 0;
        } else if (currentHash !== lastPageHash) {
          console.log('âœ¨ Page content changed!');
          console.log('ğŸ“Š Hash changed from', lastPageHash.substring(0, 8) + '...', 'to', currentHash.substring(0, 8) + '...');
          console.log('ğŸ”„ Reloading page in 1000ms...');
          
          // é‡ç½®çŠ¶æ€ï¼Œå‡†å¤‡é‡æ–°åŠ è½½
          initialized = false;
          lastPageHash = null;
          isChecking = false;
          
          setTimeout(function() {
            window.location.reload();
          }, 1000);
          return;
        } else {
          stableCount++;
          if (stableCount <= 2 || stableCount % 8 === 0) {
            console.log('ğŸ“‹ Check #' + checkCount + ' - No changes detected (stable: ' + stableCount + ')');
          }
        }
        
        isChecking = false;
      }).catch(function(error) {
        console.log('âŒ Check #' + checkCount + ' failed:', error.message);
        isChecking = false;
      });
    }
    
    // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åå¼€å§‹æ£€æŸ¥
    setTimeout(function() {
      checkForUpdates();
      
      // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
      const interval = setInterval(checkForUpdates, 5000);
      
      // é¡µé¢å¸è½½æ—¶æ¸…ç†
      window.addEventListener('beforeunload', function() {
        clearInterval(interval);
      });
    }, 3000);
    
    // ç›‘å¬é¡µé¢ç„¦ç‚¹ï¼Œç”¨æˆ·å›åˆ°é¡µé¢æ—¶ç«‹å³æ£€æŸ¥ï¼ˆä»…åœ¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´å¾ˆè¿‘æ—¶ï¼‰
    window.addEventListener('focus', function() {
      if (initialized) {
        // åªæœ‰åœ¨æœ€è¿‘30ç§’å†…æ‰æ£€æŸ¥æ›´æ–°ï¼Œé¿å…æ­£å¸¸æµè§ˆæ—¶çš„è¯¯è§¦å‘
        const lastCheck = localStorage.getItem('lastLiveReloadCheck');
        const now = Date.now();
        if (!lastCheck || (now - parseInt(lastCheck)) > 30000) {
          console.log('ğŸ‘ï¸ Page focused - checking for updates...');
          localStorage.setItem('lastLiveReloadCheck', now.toString());
          setTimeout(checkForUpdates, 800);
        }
      }
    });
    
    console.log('âœ… Custom Live Reload initialized');
    console.log('ğŸ’¡ Will check for content changes every 5 seconds');
    console.log('ğŸ¯ Only real content changes will trigger reload');
  }
})();
</script>

<script>
/* Service Worker æ³¨å†Œ - æå‡ç¼“å­˜æ€§èƒ½ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

/* æŒä¹…åŒ–éŸ³ä¹æ’­æ”¾å™¨ - é¿å…Pjaxé‡ç½® */
(function() {
    'use strict';
    
    let musicPlayer = null;
    const MUSIC_PLAYER_ID = 'persistent-music-player';
    
    // åˆ›å»ºéŸ³ä¹æ’­æ”¾å™¨HTML
    function createMusicPlayer() {
        const playerHtml = `
            <div id="${MUSIC_PLAYER_ID}" class="persistent-music-player minimized">
                <div class="music-controls">
                    <button class="music-toggle-btn" onclick="toggleMusicPlayer()" title="ç‚¹å‡»åˆ‡æ¢æ’­æ”¾å™¨æ˜¾ç¤º/éšè—&#10;æ¡Œé¢ç«¯å³é”®å¼€å¯/å…³é—­æ—‹è½¬&#10;æ‰‹æœºç«¯é•¿æŒ‰2ç§’å¼€å¯/å…³é—­æ—‹è½¬">â™ª</button>
                    <button class="music-minimize-btn" onclick="minimizeMusicPlayer()" title="æœ€å°åŒ–">âˆ’</button>
                </div>
                <div class="music-iframe-container">
                    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" 
                            width="330" height="450" loading="lazy"
                            sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
                            src="//music.163.com/outchain/player?type=0&id=6922474495&auto=0&height=430">
                    </iframe>
                </div>
            </div>
        `;
        return playerHtml;
    }
    
    // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
    function initMusicPlayer() {
        // å¦‚æœå·²å­˜åœ¨ï¼Œä¸é‡å¤åˆ›å»º
        if (document.getElementById(MUSIC_PLAYER_ID)) {
            return;
        }
        
        // åˆ›å»ºæ’­æ”¾å™¨å®¹å™¨
        const playerContainer = document.createElement('div');
        playerContainer.innerHTML = createMusicPlayer();
        
        // æ·»åŠ åˆ°bodyæœ«å°¾ï¼Œç¡®ä¿ä¸è¢«Pjaxå½±å“
        document.body.appendChild(playerContainer.firstElementChild);
        
        // æ’­æ”¾å™¨é»˜è®¤ä¸ºæœ€å°åŒ–çŠ¶æ€
        const player = document.getElementById(MUSIC_PLAYER_ID);
        player.classList.add('minimized');
    }
    
    // éŸ³ä¹å›¾æ ‡æ—‹è½¬æ§åˆ¶
    let musicIconRotating = false;
    let longPressTimer = null;
    
    // åˆ‡æ¢éŸ³ä¹å›¾æ ‡æ—‹è½¬çŠ¶æ€
    function toggleMusicRotation() {
        const toggleBtn = document.querySelector('.music-toggle-btn');
        if (!toggleBtn) return;
        
        musicIconRotating = !musicIconRotating;
        
        if (musicIconRotating) {
            toggleBtn.classList.add('rotating');
            localStorage.setItem('musicIconRotating', 'true');
        } else {
            toggleBtn.classList.remove('rotating');
            localStorage.setItem('musicIconRotating', 'false');
        }
    }
    
    // æ¢å¤éŸ³ä¹å›¾æ ‡æ—‹è½¬çŠ¶æ€
    function restoreMusicRotationState() {
        const toggleBtn = document.querySelector('.music-toggle-btn');
        if (!toggleBtn) return;
        
        const savedState = localStorage.getItem('musicIconRotating');
        if (savedState === 'true') {
            musicIconRotating = true;
            toggleBtn.classList.add('rotating');
        }
    }
    
    // æ·»åŠ éŸ³ä¹å›¾æ ‡äº¤äº’äº‹ä»¶
    function addMusicIconEvents() {
        const toggleBtn = document.querySelector('.music-toggle-btn');
        if (!toggleBtn) return;
        
        // æ¡Œé¢ç«¯å³é”®äº‹ä»¶
        toggleBtn.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            toggleMusicRotation();
        });
        
        // ç§»åŠ¨ç«¯é•¿æŒ‰äº‹ä»¶
        toggleBtn.addEventListener('touchstart', function(e) {
            longPressTimer = setTimeout(function() {
                toggleMusicRotation();
                // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }, 2000);
        });
        
        toggleBtn.addEventListener('touchend', function(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        toggleBtn.addEventListener('touchmove', function(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        // æ¢å¤æ—‹è½¬çŠ¶æ€
        restoreMusicRotationState();
    }
    
    // åˆ‡æ¢æ’­æ”¾å™¨æ˜¾ç¤º/éšè—
    window.toggleMusicPlayer = function() {
        const player = document.getElementById(MUSIC_PLAYER_ID);
        if (!player) return;
        
        if (player.classList.contains('minimized')) {
            player.classList.remove('minimized');
            localStorage.setItem('musicPlayerMinimized', 'false');
        } else {
            player.classList.add('minimized');
            localStorage.setItem('musicPlayerMinimized', 'true');
        }
    };
    

    
    // æœ€å°åŒ–æ’­æ”¾å™¨
    window.minimizeMusicPlayer = function() {
        const player = document.getElementById(MUSIC_PLAYER_ID);
        if (!player) return;
        
        player.classList.add('minimized');
        localStorage.setItem('musicPlayerMinimized', 'true');
    };
    

    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initMusicPlayer();
            setTimeout(addMusicIconEvents, 100);
        });
    } else {
        initMusicPlayer();
        setTimeout(addMusicIconEvents, 100);
    }
    
    // Pjaxé¡µé¢åˆ‡æ¢å¤„ç† - ç¡®ä¿éŸ³ä¹æ’­æ”¾å™¨ä¸è¢«é‡ç½®
    document.addEventListener('pjax:send', function() {
        // Pjaxå¼€å§‹æ—¶ä¿å­˜æ’­æ”¾å™¨çŠ¶æ€
        const player = document.getElementById(MUSIC_PLAYER_ID);
        if (player) {
            // ä¸´æ—¶éšè—æ’­æ”¾å™¨ï¼Œé¿å…è¢«Pjaxå½±å“
            player.style.display = 'none';
            console.log('ğŸµ Music player hidden during Pjax navigation');
        }
    });
    
    document.addEventListener('pjax:complete', function() {
        setTimeout(function() {
            const existingPlayer = document.getElementById(MUSIC_PLAYER_ID);
            if (existingPlayer) {
                // æ¢å¤æ’­æ”¾å™¨æ˜¾ç¤º
                existingPlayer.style.display = '';
                console.log('ğŸµ Music player restored after Pjax navigation');
            } else {
                // å¦‚æœæ’­æ”¾å™¨è¢«æ„å¤–ç§»é™¤ï¼Œé‡æ–°åˆ›å»º
                initMusicPlayer();
                setTimeout(addMusicIconEvents, 100);
                console.log('ğŸµ Music player recreated after Pjax navigation');
            }
        }, 100);
    });
    
    // å¤„ç†Pjaxå¤±è´¥çš„æƒ…å†µ
    document.addEventListener('pjax:error', function() {
        const player = document.getElementById(MUSIC_PLAYER_ID);
        if (player) {
            player.style.display = '';
            console.log('ğŸµ Music player restored after Pjax error');
        }
    });
    
})();


</script>
